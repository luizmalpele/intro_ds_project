---
title: "R Notebook"
output: html_notebook
  #html_document:
   # df_print: paged
---

```{r}
library(tidyverse)
library(caret)
library(fastDummies)
library(leaps)
library(cowplot)
library(GGally)
```

```{r}
onlineCourses <- read.csv("https://raw.githubusercontent.com/reisanar/datasets/master/harvardMIT.csv")
```

```{r}
onlineCourses2 <- onlineCourses %>% dummy_cols(select_columns = "Course.Subject") 
onlineCourses2
```


## Introduction

This project investigates the harvardMIT.csv dataset, which brings data regarding online courses of these two academical institutions. The main objective is to examine the factors that have the most significant impact on lower completion rates and to create predictive linear models that will anticipate what will be the completion rate of courses that will further be created by Harvard and MIT. After understanding what predictors that drop the average completion rate, it will be possible to change the course format and for marketing to target the population that is more likely to complete the course.


## Renaming Variables

```{r}
online_courses <- onlineCourses2 %>% rename(participants = Participants..Course.Content.Accessed., institution = Institution, course_number = Course.Number, launch_date = Launch.Date, course = Course.Title, instructors = Instructors, subject = Course.Subject, year = Year, honor_certificate = Honor.Code.Certificates, half_completed = 
Audited....50..Course.Content.Accessed., completed = Certified, completed_ratio = X..Certified, half_completed_ratio = X..Audited, completed_given_half_ratio = X..Certified.of...50..Course.Content.Accessed, played_video_ratio = X..Played.Video, posted_forum_ratio = X..Posted.in.Forum, grade_above_zero = X..Grade.Higher.Than.Zero, course_hours = Total.Course.Hours..Thousands., hours_certification_median = Median.Hours.for.Certification, age_median = Median.Age, male_ratio = X..Male, female_ratio = X..Female, bachelor_ratio = X..Bachelor.s.Degree.or.Higher, subject_cs =  "Course.Subject_Computer Science", subject_gov = "Course.Subject_Government, Health, and Social Science", subject_hum = "Course.Subject_Humanities, History, Design, Religion, and Education", subject_stem = "Course.Subject_Science, Technology, Engineering, and Mathematics") %>%
  mutate(ln_participants = log(participants), ln_completed_ratio = log(completed_ratio), ln_hours_certification_median = log(hours_certification_median))

online_courses
```

__Transforming Infinite values into NA values__

```{r}
#This function was created to transform infinite values to NA values. When the log of completed_ratio column was taken, all values that were 0 were converted to "-Inf", the function willconvert them to NA and will be removed.

inf_to_NA <- function(x)
{
    for (i in 1:ncol(x)){
          x[,i][is.infinite(x[,i])] = NA
    }
    return(x)
}
online_courses <- inf_to_NA(online_courses)
online_courses
```


## Data Dictionary

|Field Name | Description | Data Type | Data Size| Format|
|:----------|:---------------|:---------|:------------|
|institution|Name of institution|Factor|290|MITx|
|course_number|Number of course|Factor|290|6.002x|
|launch_day|Day the course started|Factor|290|09/05/2012|
|course|Name of the course|Factor|290|Circuits and Electronics|
|instructures|Name of instructors|Factor|290|Khurram Afridi|
|subject|Course area (STEM, Science, Computer Science, or Humanities)|Factor|290|Science, Technology, Engineering, and Mathematics|
|year|University years ranking|Integer|290|1|
|honor_certificate|If the course is part of the honor code certificate|Integer|290|1|
|participants|Total number of enrolled students in the course|Integer|290|36105|
|half_completed|Number of students who completed half of the course|Integer|290|5431|
|completed|Number of students who completed the course|Integer|290|3003|
|half_completed_ratio| Ratio of students who completed half of the course given total number of enrolled students in the course|Double|290|15.04|
|completed_ratio|Ratio of students who completed the course given total number of enrolled students in the course|Double|290|8.32|
|completed_given_half_ratio|Ratio of students who completed the course given students who completed half of the course|Double|290|54.98|
|played_video_ratio|Percentage of students who played the class videos|Factor|290|83.2|
|posted_forum_ratio|Percentage of students who posted on the class forum|Double|290|8.17|
|grade_above_zero|Percentage of students who scored more than zero in the class|Double|290|28.97|
|course_hours|Total number of hours of the course|Double|290|418.94|
|hours_certification_median|Median number of hours it takes to get the certification|Double|290|64.45|
|age_median|Median age of students who took the course|Double|290|26.0|
|male_ratio|Percentage of male students given the total number of participants|Double|290|88.28|
|female_ratio|Percentage of female students given the total number of participants|Double|290|11.72|
|bachelor_ratio| Percentage of students who has a bachelor degree|Double|290|60.68|
|subject_cs|Course in the Computer Science study area|Integer|290|0|
|subject_gov|Course in the Government, Health, and Social Science study area|Integer|290|0|
|subject_hum|Course in the Humanities, History, Design, Religion, and Educatione study area|Integer|290|0|
|subject_stem|Course in the Science, Technology, Engineering, and Mathematics study area|Integer|290|1|
|ln_participants|Natural logarithm of the total number of participants in the course|Double|290|10.494187	|
|ln_completed_ratio|Natural logarithm of the ratio of students who completed the course given total number of enrolled students in the course|Double|290|2.11866225|

__Important information related to the data:__

- The log transformed variable for course participants is approximately normal
- The log transformed variable for completed ratio is closer to a normal distribution than the original variable.


__EDA__

```{r}
#calculating the average and standard deviation of completed ratio
online_courses %>% 
  group_by(year) %>% 
  summarize(average_certified = mean(completed_ratio),sd_certified_ratio = sd(completed_ratio))
```

## Log Transformation

```{r}
hist1 <- ggplot(data=online_courses) + geom_histogram(mapping = aes(x = participants), alpha = 0.6, fill = "blue") +  labs(title = "Variable Distribution", x = "Variable: participants", y = "Frequency")
hist2 <- ggplot(data=online_courses) + geom_histogram(mapping = aes(x = ln_participants), alpha = 0.6, fill = "blue") +  labs(title = "Log-transformed Var.", x = "Variable: ln_participants", y = "Frequency")
hist3 <- ggplot(data=online_courses) + geom_histogram(mapping = aes(x = completed_ratio), alpha = 0.6, fill = "dark red") +  labs(title = "Variable Distribution", x = "Variable: completed_ratio", y = "Frequency")
hist4 <- ggplot(data=online_courses) + geom_histogram(mapping = aes(x = ln_completed_ratio), alpha = 0.6, fill = "dark red") +  labs(title = "Log-transformed Var.", x = "Variable: ln_completed_ratio", y = "Frequency")
hist5 <- ggplot(data=online_courses) + geom_histogram(mapping = aes(x = hours_certification_median), alpha = 0.6, fill = "orange") +  labs(title = "Variable Distribution", x = "hours_certification_median", y = "Frequency")
hist6 <- ggplot(data=online_courses) + geom_histogram(mapping = aes(x = ln_hours_certification_median), alpha = 0.6, fill = "orange") +  labs(title = "Log-transformed Var.", x = "ln_hours_certification_median", y = "Frequency")

plot_grid(hist1, hist2, hist3, hist4, hist5, hist6, labels = "AUTO")
```

Since the objective of this project is to create a predictive linear model and the response variable is completed_ratio, it is better to model it as a log transformed variable. This provide some strategic advantages such as: 
- $\hat{\beta_0}$ is a strictly positive y-intercept;
- A unit change on the log is proportional to the percent change on the variable;
- It is possible to back transform the log transformed variable by exponentiation: $e^\hat{y}$;
- When a variable is not normally distributed (highly-skewed), log transformation helps capturing the non-linear relationship between an explanatory variable and the response variable.
For the reasons mentioned above _participant, completed_ratio_ and _hours_certification_median_ were log-transformed, and the skewness aspect of the variable was reduced.


```{r}
online_courses_shrinked <- online_courses %>% select(ln_completed_ratio, year, ln_participants, grade_above_zero, bachelor_ratio, ln_hours_certification_median)
```

```{r}
ggpairs(online_courses_shrinked)
```

This correlation pannel shows that the response _ln_completed_ratio_ has a person's correlation r of 0.635 wil _grade_above_zero_, 0.409 with _bachelor_ratio_, and -0.441 with _ln_hours_certification_median_. This fact show that these three variables are strong candidates to be expanatory variables for the prediction of _completion ratio_. On the other hand, both _year_, and _ln_participants_ have correlation with the response, they will be tested for modeling, but will not probably be used as predictors.

## Exploring correlation with binary variables.

```{r}
institution=rep(c("HarvardX","MITx"),each=20)
box1 <- online_courses %>% gather(subject_cs, subject_gov, subject_hum, subject_stem, key = "subject", value = "boolean_auxiliar") %>% filter(boolean_auxiliar == 1) %>% ggplot() + geom_boxplot(aes(x=subject, y=completed_ratio, fill= institution), 
             alpha = 0.6) + 
  labs(
    title = "Subject versus Course Completion Ratio", 
    x = "Subject", 
    y = "Course Completion Percentage", 
    fill = "Institution"
  ) + 
  scale_fill_brewer(palette = "Set1")

box1
```

```{r}
institution=rep(c("HarvardX","MITx"),each=20)
box1 <- online_courses %>% gather(subject_cs, subject_gov, subject_hum, subject_stem, key = "subject", value = "boolean_auxiliar") %>% filter(boolean_auxiliar == 1) %>% ggplot() + geom_boxplot(aes(x=subject, y=completed_ratio, fill= institution), 
             alpha = 0.6) + 
  labs(
    title = "Subject versus Course Completion Ratio", 
    x = "Subject", 
    y = "Course Completion Percentage", 
    fill = "Institution"
  ) + 
  scale_fill_brewer(palette = "Set1") + 
  facet_wrap(~institution)
  

box1
```


```{r}
point1 <- online_courses %>%  ggplot() + geom_point(aes(x=grade_above_zero, y=completed_ratio, color = institution), 
             alpha = 0.6) + 
  labs(
    title = "Percentage of Grades Above Zero versus Course Completion Percentage ", 
    x = "Percentage of Grades Above Zero", 
    y = "Course Completion Percentage", 
    fill = "Institution"
  ) + 
  scale_color_brewer(palette = "Set1")

point1
```

```{r}
point2 <- online_courses %>% ggplot() + geom_point(aes(x=ln_hours_certification_median, y=completed_ratio, color = institution), 
             alpha = 0.6) + 
  labs(
    title = "Log of Median Hours for Certification versus Course Completion Percentage ", 
    x = "Natural Log of Median Hours for Certification", 
    y = "Course Completion Percentage", 
    color = "Institution"
  ) + 
  scale_color_brewer(palette = "Set1")

point2
```

```{r}
point3 <- online_courses %>% ggplot() + geom_point(aes(x=bachelor_ratio, y=completed_ratio, color = institution), 
             alpha = 0.6) + 
  labs(
    title = "Percentage of Students who have a Bachelor Degree versus Course Completion", 
    x = "Natural Log of Median Hours for Certification", 
    y = "Percentage of Students who have a Bachelor Degree", 
    color = "Institution"
  ) + 
  scale_color_brewer(palette = "Set1")

point3
```

```{r, out.width = 7}
ggplot(data = online_courses)+
  geom_point(aes(x = year, y = completed_ratio, color = institution), alpha = .6, size = 3)+
  facet_wrap(~subject)+
  labs(title = "Grade Level versus Course Completion Ratio per Subject", 
    x = "Grade Level", 
    y = "Course Completion Ratio", 
    color = "Institution") + 
  scale_color_brewer(palette = "Set1")
```


```{r}
ggplot(online_courses)+
  geom_col(aes(x = institution, y = ln_participants, fill = subject), pposition = "fill")+ 
  scale_fill_brewer(palette = "Set1")
```

## Linear Models

__Filtering NA values__

```{r}
lm_online_data <- online_courses %>% filter(!is.na(ln_completed_ratio)) %>% filter(!is.na(ln_hours_certification_median))
lm_online_data
```

__Separating the data into Train and Test__

```{r}
set.seed(123)
train_control <-  trainControl(method = "cv", number = 10)
inTrain <- createDataPartition(y = lm_online_data$ln_completed_ratio, p = 0.7, list = FALSE)
train_set <- lm_online_data[inTrain , ]
test_set <- lm_online_data[-inTrain , ]
```

__Variables selection__

```{r}
#Separating the data
sub_fit_certified <- regsubsets(ln_completed_ratio ~ institution + subject_stem + subject_cs + ln_hours_certification_median + year + age_median + bachelor_ratio + grade_above_zero , data = train_set)
best_summary <- summary(sub_fit_certified)

#Plots
par(mfrow = c(1,2))
plot(best_summary$cp, xlab = "number of features", ylab = "cp")
plot(sub_fit_certified, scale = "Cp")
par(mfrow = c(1,2))
plot(best_summary$adjr2)
plot(best_summary$bic)
```

 Based on BIC, Mallows' CP, and the $Adjusted-R^2$, the select model will account for 5 variables, more than this will result in overfitting and these variables will be: _instution, subject_cs, hours_certification_median, _bachelor_ratio, subject_stem, and grade_above_zero_. 
 
# Modeling With other Techniques

## Simple Limnear Regression
 
```{r}
lm_train_courses <- lm(ln_completed_ratio ~ institution + subject_cs + subject_stem + ln_hours_certification_median + bachelor_ratio + grade_above_zero, 
                        data = train_set)
summary(lm_train_courses)
```

```{r}
#Training Data
lm_train_data <- predict(lm_train_courses)
unlog_forecast_lm <- exp(lm_train_data)
unlog_actual <- exp(train_set$ln_completed_ratio)
```

```{r}
ggplot(train_set, aes(x = unlog_forecast_lm, y = unlog_actual),alpha = 0.6) + 
  geom_point(color = "Dark Blue") + 
  geom_smooth(method = lm, color = "Dark Red") +  
  labs(title = "Forecast versus Actuals - Simple Linear Regression (Train Data)", 
                                   x = "Forecast", 
                                   y = "Actual")
```


```{r}
lm_test_data <- predict(lm_train_courses, test_set)

RMSE1 <- mean((lm_test_data - test_set$ln_completed_ratio)^2) 
RMSE1
unlog_forecast_lm1 <- exp(lm_test_courses)
unlog_actual1 <- exp(test_set$ln_completed_ratio)

```

```{r}
ggplot(test_set, aes(x = unlog_forecast_lm1, y = unlog_actual1),alpha = 0.6) + 
  geom_point(color = "Dark Blue") + 
  geom_smooth(method = lm, color = "Dark Red") +  labs(title = "Forecast versus Actuals - Simple Linear Regression (Test Data)",
                                   x = "Forecast", 
                                   y = "Actual") + scale_fill_brewer(palette = "Set1")
```


## LASSO Regression
 
```{r}
set.seed(981)
#10 fold CV
train_control <-  trainControl(method = "cv", number = 10)
#Grid
grid <- seq(-2,10,length=100)

lasso_model <- train(ln_completed_ratio ~ institution + subject_cs + subject_stem + ln_hours_certification_median + bachelor_ratio + grade_above_zero,
                     data = train_set, 
                     method = "glmnet", 
                     trControl = train_control,
                     metric =  "Rsquared",
                     tune_Grid = expand.grid(alpha = 1, lambda = grid))

lasso_model
```
 
 The best LASSO model has a $/alpha=0.1$ and $/lambda=0.01374326$. The RMSE value for this model is 0.68566, while the $R^2$ is 0.6206.

```{r}
#Training Data
lasso_train_data <- predict(lasso_model)
unlog_forecast_lasso <- exp(lasso_train_data)
unlog_actual <- exp(train_set$ln_completed_ratio)
ggplot(train_set, aes(x = unlog_forecast_lasso, y = unlog_actual),alpha = 0.6) + 
  geom_point(color = "Dark Blue") + 
  geom_smooth(method = lm, color = "Dark Red") +  labs(title = "Forecast versus Actuals - LASSO (Train Data)", x = "Forecast", y = "Actual")
```


```{r}
lm_test_lasso_courses <- predict(lasso_model, test_set)
RMSE2 <- mean((lm_test_lasso_courses - test_set$ln_completed_ratio)^2) 
RMSE2

#Test Data
unlog_forecast_lasso <- exp(lm_test_lasso_courses)
unlog_actual <- exp(test_set$ln_completed_ratio)
ggplot(test_set, aes(x = unlog_forecast_lasso, y = unlog_actual),alpha = 0.6) + 
  geom_point(color = "Dark Blue") + 
  geom_smooth(method = lm, color = "Dark Red") +  labs(title = "Forecast versus Actuals - LASSO (Test Data)", x = "Forecast", y = "Actual")
```

## Ridge Regression
 
```{r}
set.seed(981)
ridge_model <- train(ln_completed_ratio ~ institution + subject_cs + subject_stem + hours_certification_median + bachelor_ratio + grade_above_zero,
                     data = train_set, 
                     method = "glmnet", 
                     trControl = train_control,
                     metric =  "Rsquared",
                     tune_Grid = expand.grid(alpha = 0, lambda = grid))

ridge_model
```

 The best Ridge model has a $/alpha=0.1$ and $/lambda=0.013743260$. The RMSE value for this model is 0.7247954, while the $R^2$ is 0.5961.
 
```{r}
#Training Data
ridge_train_data <- predict(ridge_model)
unlog_forecast_ridge <- exp(ridge_train_data)
unlog_actual <- exp(train_set$ln_completed_ratio)
ggplot(train_set, aes(x = unlog_forecast_ridge, y = unlog_actual),alpha = 0.6) + 
  geom_point(color = "Dark Blue") + 
  geom_smooth(method = lm, color = "Dark Red") +  labs(title = "Forecast versus Actuals - Ridge (Train Data)", x = "Forecast", y = "Actual")
```
 
 
```{r}
lm_test_ridge_courses <- predict(ridge_model, test_set)
RMSE3 <- mean((lm_test_ridge_courses - test_set$ln_completed_ratio)^2) 
RMSE3

#Test Data
unlog_forecast_ridge <- exp(lm_test_ridge_courses)
unlog_actual <- exp(test_set$ln_completed_ratio)
ggplot(test_set, aes(x = unlog_forecast_ridge, y = unlog_actual),alpha = 0.6) + 
  geom_point(color = "Dark Blue") + 
  geom_smooth(method = lm, color = "Dark Red") +  labs(title = "Forecast versus Actuals - Ridge (Test Data)", x = "Forecast", y = "Actual")
```